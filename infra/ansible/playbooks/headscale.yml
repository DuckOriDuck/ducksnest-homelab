---
# Headscale ì„œë²„ ì„¤ì • í”Œë ˆì´ë¶ (Native Installation)

- name: Setup Headscale Server
  hosts: headscale
  become: true
  gather_facts: true

  tasks:
    # Headscale ë°”ì´ë„ˆë¦¬ ì„¤ì¹˜
    - name: Create headscale user
      user:
        name: headscale
        system: yes
        shell: /bin/false
        home: /var/lib/headscale
        create_home: yes
        
    - name: Create headscale directories
      file:
        path: "{{ item }}"
        state: directory
        owner: headscale
        group: headscale
        mode: '0755'
      loop:
        - /etc/headscale
        - /var/lib/headscale
        - /opt/headscale/backups
        - /opt/headscale/scripts
        - /opt/headscale/logs
        
    - name: Detect system architecture
      command: dpkg --print-architecture
      register: system_arch
      changed_when: false
      
    - name: Set headscale architecture
      set_fact:
        headscale_arch: "{{ 'arm64' if system_arch.stdout == 'arm64' else 'amd64' }}"
        
    - name: Download headscale binary
      get_url:
        url: "https://github.com/juanfont/headscale/releases/download/v{{ headscale_version }}/headscale_{{ headscale_version }}_linux_{{ headscale_arch }}"
        dest: /usr/local/bin/headscale
        mode: '0755'
        owner: root
        group: root
        
    - name: Generate headscale private key
      shell: |
        if [ ! -f /etc/headscale/private.key ]; then
          /usr/local/bin/headscale generate private-key > /etc/headscale/private.key
        fi
      args:
        creates: /etc/headscale/private.key
        
    - name: Set private key permissions
      file:
        path: /etc/headscale/private.key
        owner: headscale
        group: headscale
        mode: '0600'
        
    - name: Create headscale configuration
      copy:
        content: |
          server_url: https://{{ ansible_host }}
          listen_addr: {{ headscale_listen_addr }}
          metrics_listen_addr: {{ headscale_metrics_listen_addr }}
          grpc_listen_addr: {{ headscale_grpc_listen_addr }}
          grpc_allow_insecure: false
          
          private_key_path: /etc/headscale/private.key
          noise:
            private_key_path: /etc/headscale/noise_private.key
          
          ip_prefixes:
          {% for prefix in headscale_ip_prefixes %}
            - {{ prefix }}
          {% endfor %}
          
          derp:
            server:
              enabled: false
            urls:
              - {{ headscale_derp_map_url }}
            auto_update_enabled: {{ headscale_derp_auto_update_enabled | lower }}
            update_frequency: {{ headscale_derp_update_frequency }}
          
          disable_check_updates: false
          ephemeral_node_inactivity_timeout: 30m
          database:
            type: sqlite3
            sqlite:
              path: /var/lib/headscale/db.sqlite
          
          acl_policy_path: /etc/headscale/acl.hujson
          
          dns_config:
            override_local_dns: {{ headscale_dns_config.override_local_dns | lower }}
            nameservers:
            {% for ns in headscale_dns_config.nameservers %}
              - {{ ns }}
            {% endfor %}
            domains:
            {% for domain in headscale_dns_config.domains %}
              - {{ domain }}
            {% endfor %}
            magic_dns: true
            base_domain: {{ homelab_domain }}
          
          logtail:
            enabled: false
          
          randomize_client_port: false
        dest: /etc/headscale/config.yaml
        owner: headscale
        group: headscale
        mode: '0644'
        
    - name: Create headscale ACL policy
      copy:
        content: "{{ headscale_acl_policy }}"
        dest: /etc/headscale/acl.hujson
        owner: headscale
        group: headscale
        mode: '0644'
        
    # Systemd ì„œë¹„ìŠ¤ ì„¤ì •
    - name: Create headscale systemd service
      copy:
        content: |
          [Unit]
          Description=headscale coordination server
          After=syslog.target
          After=network.target
          
          [Service]
          Type=simple
          User=headscale
          Group=headscale
          ExecStart=/usr/local/bin/headscale serve
          Restart=always
          RestartSec=5
          
          # Optional security enhancements
          NoNewPrivileges=true
          PrivateTmp=true
          ProtectSystem=strict
          ProtectHome=true
          ReadWritePaths=/var/lib/headscale /var/log
          AmbientCapabilities=CAP_NET_BIND_SERVICE
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/headscale.service
        mode: '0644'
        
    - name: Reload systemd and start headscale
      systemd:
        daemon_reload: yes
        name: headscale
        state: started
        enabled: yes
        
    - name: Wait for headscale to start
      wait_for:
        port: 8080
        host: "{{ ansible_host }}"
        timeout: 120
        
    - name: Create headscale user
      shell: |
        /usr/local/bin/headscale users create {{ ansible_user }} || true
      become_user: headscale
      
    - name: Generate headscale pre-auth key
      shell: |
        /usr/local/bin/headscale --user {{ ansible_user }} preauthkeys create --reusable --expiration 24h
      register: headscale_preauth_key
      become_user: headscale
      
    - name: Create additional pre-auth keys for different client types
      shell: |
        /usr/local/bin/headscale --user {{ ansible_user }} preauthkeys create --reusable --expiration 7d --tags "nixos-client"
      register: nixos_preauth_key
      become_user: headscale
      
    - name: Create K8s pre-auth key
      shell: |
        /usr/local/bin/headscale --user {{ ansible_user }} preauthkeys create --reusable --expiration 7d --tags "k8s-control-plane"
      register: k8s_preauth_key
      become_user: headscale
      
    - name: Create headscale management script
      copy:
        content: |
          #!/usr/bin/env bash
          # Headscale ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸
          
          set -euo pipefail
          
          HEADSCALE_USER="{{ ansible_user }}"
          
          case "${1:-help}" in
            "users")
              /usr/local/bin/headscale users list
              ;;
            "nodes")
              /usr/local/bin/headscale nodes list
              ;;
            "routes")
              echo "ğŸ“‹ ë¼ìš°íŠ¸ ëª©ë¡:"
              /usr/local/bin/headscale routes list
              echo ""
              echo "ìŠ¹ì¸ë˜ì§€ ì•Šì€ ë¼ìš°íŠ¸ë¥¼ ìŠ¹ì¸í•˜ë ¤ë©´:"
              echo "  headscale-manage enable-route <route-id>"
              ;;
            "enable-route")
              if [ -n "${2:-}" ]; then
                /usr/local/bin/headscale routes enable -r "$2"
                echo "âœ… ë¼ìš°íŠ¸ $2 ìŠ¹ì¸ë¨"
              else
                echo "Usage: $0 enable-route <route-id>"
                exit 1
              fi
              ;;
            "enable-all-routes")
              echo "ğŸ”„ ëª¨ë“  ë¼ìš°íŠ¸ ìë™ ìŠ¹ì¸ ì¤‘..."
              /usr/local/bin/headscale routes list -o json | \
                jq -r '.[] | select(.Enabled == false) | .ID' | \
                while read -r route_id; do
                  echo "ìŠ¹ì¸ ì¤‘: Route ID $route_id"
                  /usr/local/bin/headscale routes enable -r "$route_id"
                done
              echo "âœ… ëª¨ë“  ë¼ìš°íŠ¸ ìŠ¹ì¸ ì™„ë£Œ"
              ;;
            "create-key")
              local tag="${2:-general}"
              local expiry="${3:-24h}"
              echo "ğŸ”‘ ìƒˆ pre-auth key ìƒì„± ì¤‘..."
              /usr/local/bin/headscale --user "$HEADSCALE_USER" preauthkeys create --reusable --expiration "$expiry" --tags "$tag"
              ;;
            "network-info")
              echo "ğŸŒ Headscale ë„¤íŠ¸ì›Œí¬ ì •ë³´:"
              echo "  ì„œë²„ URL: https://{{ ansible_host }}"
              echo "  ì‚¬ìš©ì: $HEADSCALE_USER"
              echo ""
              echo "ğŸ“Š ì—°ê²°ëœ ë…¸ë“œ:"
              /usr/local/bin/headscale nodes list
              echo ""
              echo "ğŸ›£ï¸  ë„¤íŠ¸ì›Œí¬ ë¼ìš°íŠ¸:"
              /usr/local/bin/headscale routes list
              ;;
            "status")
              echo "ğŸ” Headscale ì„œë¹„ìŠ¤ ìƒíƒœ:"
              systemctl status headscale --no-pager
              echo ""
              echo "ğŸ“Š ë„¤íŠ¸ì›Œí¬ í†µê³„:"
              /usr/local/bin/headscale nodes list | wc -l | xargs echo "ì—°ê²°ëœ ë…¸ë“œ:"
              ;;
            "logs")
              echo "ğŸ“ Headscale ë¡œê·¸:"
              journalctl -u headscale -n 50 --no-pager
              ;;
            "help"|*)
              echo "Headscale ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸"
              echo ""
              echo "ì‚¬ìš©ë²•: $0 <command> [options]"
              echo ""
              echo "Commands:"
              echo "  users              - ì‚¬ìš©ì ëª©ë¡"
              echo "  nodes              - ì—°ê²°ëœ ë…¸ë“œ ëª©ë¡"
              echo "  routes             - ë„¤íŠ¸ì›Œí¬ ë¼ìš°íŠ¸ ëª©ë¡"
              echo "  enable-route <id>  - íŠ¹ì • ë¼ìš°íŠ¸ ìŠ¹ì¸"
              echo "  enable-all-routes  - ëª¨ë“  ë¼ìš°íŠ¸ ìë™ ìŠ¹ì¸"
              echo "  create-key [tag] [expiry] - ìƒˆ pre-auth key ìƒì„±"
              echo "  network-info       - ì „ì²´ ë„¤íŠ¸ì›Œí¬ ì •ë³´"
              echo "  status             - ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
              echo "  logs               - ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
              echo "  help               - ë„ì›€ë§ í‘œì‹œ"
              ;;
          esac
        dest: /usr/local/bin/headscale-manage
        mode: '0755'
        owner: root
        group: root
        
    - name: Save pre-auth keys to local files
      copy:
        content: |
          # Headscale Pre-Auth Keys
          # Generated on {{ ansible_date_time.date }} {{ ansible_date_time.time }}
          
          # Default key (24h)
          DEFAULT_KEY={{ headscale_preauth_key.stdout }}
          
          # NixOS clients key (7d)
          NIXOS_KEY={{ nixos_preauth_key.stdout }}
          
          # K8s Control Plane key (7d)
          K8S_KEY={{ k8s_preauth_key.stdout }}
          
          # Usage:
          # NixOS clients: tailscale up --login-server https://{{ ansible_host }} --authkey $NIXOS_KEY
          # K8s CP: tailscale up --login-server https://{{ ansible_host }} --authkey $K8S_KEY
        dest: /opt/headscale/keys/preauth-keys.env
        mode: '0600'
        owner: headscale
        group: headscale
        
    - name: Create keys directory
      file:
        path: /opt/headscale/keys
        state: directory
        owner: headscale
        group: headscale
        mode: '0700'
      
    - name: Display headscale information
      debug:
        msg: |
          ğŸ”— Headscale Mesh Network ì„¤ì • ì™„ë£Œ!
          
          ì„œë²„ ì •ë³´:
          - URL: https://{{ ansible_host }}
          - ì‚¬ìš©ì: {{ ansible_user }}
          
          Pre-Auth Keys:
          - Default (24h): {{ headscale_preauth_key.stdout }}
          - NixOS (7d): {{ nixos_preauth_key.stdout }}
          - K8s (7d): {{ k8s_preauth_key.stdout }}
          
          ê´€ë¦¬ ëª…ë ¹ì–´:
          - headscale-manage network-info  # ì „ì²´ ë„¤íŠ¸ì›Œí¬ ì •ë³´
          - headscale-manage enable-all-routes  # ëª¨ë“  ë¼ìš°íŠ¸ ìŠ¹ì¸
          - headscale-manage nodes  # ì—°ê²°ëœ ë…¸ë“œ í™•ì¸
          
          í´ë¼ì´ì–¸íŠ¸ ì—°ê²°:
          - NixOS: ansible-playbook nixos-tailscale.yml -e headscale_preauth_key={{ nixos_preauth_key.stdout }}
          - K8s CP: ansible-playbook k8s-tailscale.yml -e headscale_preauth_key={{ k8s_preauth_key.stdout }}
          
    # ë°±ì—… ì„¤ì •
    - name: Create headscale backup script
      copy:
        content: |
          #!/bin/bash
          BACKUP_DIR="/opt/headscale/backups"
          DATE=$(date +%Y%m%d_%H%M%S)
          
          mkdir -p "$BACKUP_DIR"
          
          # Headscale ë°ì´í„° ë°±ì—…
          systemctl stop headscale
          tar czf "$BACKUP_DIR/headscale_$DATE.tar.gz" -C /var/lib/headscale .
          tar czf "$BACKUP_DIR/headscale_config_$DATE.tar.gz" -C /etc/headscale .
          systemctl start headscale
          
          # 7ì¼ ì´ìƒëœ ë°±ì—… ì‚­ì œ
          find "$BACKUP_DIR" -name "headscale_*.tar.gz" -mtime +7 -delete
          
          echo "Headscale backup completed: $DATE"
        dest: /opt/headscale/scripts/backup.sh
        mode: '0755'
        owner: root
        group: root
        
    - name: Setup headscale backup cron job
      cron:
        name: "Headscale backup"
        minute: "0"
        hour: "3"
        job: "/opt/headscale/scripts/backup.sh >> /opt/headscale/logs/backup.log 2>&1"
        user: root