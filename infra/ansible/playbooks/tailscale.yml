---
# Tailscale í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ ë° ì„¤ì • í”Œë ˆì´ë¶

- name: Install and Configure Tailscale
  hosts: aws_instances
  become: true
  gather_facts: true
  
  tasks:
    - name: Add Tailscale GPG key
      apt_key:
        url: https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg
        keyring: /usr/share/keyrings/tailscale-archive-keyring.gpg
        state: present
        
    - name: Add Tailscale repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main"
        state: present
        filename: tailscale
        
    - name: Install Tailscale
      apt:
        name: tailscale
        state: present
        update_cache: true
        
    - name: Enable IP forwarding for Tailscale
      sysctl:
        name: "{{ item }}"
        value: "1"
        sysctl_set: true
        reload: true
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding
        
    - name: Configure Tailscale to start on boot
      systemd:
        name: tailscaled
        enabled: true
        state: started
        
    # Tailscale ì—°ê²°ì€ ìˆ˜ë™ìœ¼ë¡œ í•˜ê±°ë‚˜ Jenkinsì—ì„œ ìë™í™”
    - name: Create Tailscale connection script
      copy:
        content: |
          #!/bin/bash
          # Tailscale ì—°ê²° ìŠ¤í¬ë¦½íŠ¸
          
          HEADSCALE_URL="${HEADSCALE_URL:-https://{{ hostvars[groups['jenkins_headscale'][0]]['ansible_host'] }}}"
          AUTH_KEY="${AUTH_KEY:-}"
          
          if [ -z "$AUTH_KEY" ]; then
            echo "ì‚¬ìš©ë²•: AUTH_KEY=<key> $0"
            echo "ë˜ëŠ”: $0 <auth-key>"
            echo ""
            echo "Pre-auth keyëŠ” Headscale ì„œë²„ì—ì„œ ìƒì„±í•˜ì„¸ìš”:"
            echo "docker exec headscale headscale --user ubuntu preauthkeys create --reusable --expiration 24h"
            exit 1
          fi
          
          if [ -n "$1" ]; then
            AUTH_KEY="$1"
          fi
          
          echo "Connecting to Headscale at $HEADSCALE_URL..."
          sudo tailscale up --login-server "$HEADSCALE_URL" --authkey "$AUTH_KEY" --accept-routes
          
          echo "Tailscale connection status:"
          tailscale status
          
          echo "Tailscale IP addresses:"
          tailscale ip -4
        dest: /opt/homelab/scripts/connect-tailscale.sh
        mode: '0755'
        owner: ubuntu
        group: ubuntu
        
    - name: Create Tailscale status check script
      copy:
        content: |
          #!/bin/bash
          # Tailscale ìƒíƒœ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
          
          echo "=== Tailscale Status ==="
          tailscale status
          
          echo ""
          echo "=== Network Interfaces ==="
          ip addr show tailscale0 2>/dev/null || echo "Tailscale interface not found"
          
          echo ""
          echo "=== IP Addresses ==="
          echo "IPv4: $(tailscale ip -4 2>/dev/null || echo 'Not connected')"
          echo "IPv6: $(tailscale ip -6 2>/dev/null || echo 'Not connected')"
          
          echo ""
          echo "=== DNS Configuration ==="
          tailscale status --json | jq -r '.Self.DNSName // "Not connected"' 2>/dev/null || echo "jq not available"
          
          echo ""
          echo "=== Peer Information ==="
          tailscale status --peers
        dest: /opt/homelab/scripts/tailscale-status.sh
        mode: '0755'
        owner: ubuntu
        group: ubuntu
        
    - name: Display connection instructions
      debug:
        msg: |
          ğŸ”— Tailscale ì„¤ì¹˜ ì™„ë£Œ!
          
          ì—°ê²° ë°©ë²•:
          1. Headscaleì—ì„œ pre-auth key ìƒì„±:
             docker exec headscale headscale --user ubuntu preauthkeys create --reusable --expiration 24h
          
          2. ìƒì„±ëœ í‚¤ë¡œ ì—°ê²°:
             sudo /opt/homelab/scripts/connect-tailscale.sh <auth-key>
          
          3. ìƒíƒœ í™•ì¸:
             /opt/homelab/scripts/tailscale-status.sh
          
          ì°¸ê³ : Headscale URL = https://{{ hostvars[groups['jenkins_headscale'][0]]['ansible_host'] }}