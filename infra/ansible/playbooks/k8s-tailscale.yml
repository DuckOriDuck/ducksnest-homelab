---
# K8s Control Plane Tailscale í´ë¼ì´ì–¸íŠ¸ ì„¤ì • í”Œë ˆì´ë¶

- name: Setup Tailscale on K8s Control Plane
  hosts: k8s_control_plane
  become: true
  gather_facts: true
  
  vars:
    tailscale_version: "1.76.1"
    tailscale_state_dir: /var/lib/tailscale
    
  tasks:
    # Tailscale ì„¤ì¹˜
    - name: Add Tailscale GPG key
      apt_key:
        url: https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg
        state: present
        keyring: /usr/share/keyrings/tailscale-archive-keyring.gpg
        
    - name: Add Tailscale repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main"
        state: present
        filename: tailscale
        
    - name: Install Tailscale
      apt:
        name: tailscale
        state: present
        update_cache: yes
        
    - name: Enable IP forwarding for Kubernetes
      sysctl:
        name: "{{ item }}"
        value: '1'
        state: present
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding
        
    - name: Start and enable tailscaled
      systemd:
        name: tailscaled
        state: started
        enabled: yes
        
    - name: Check tailscale status
      command: tailscale status --json
      register: tailscale_status
      failed_when: false
      changed_when: false
      
    - name: Parse tailscale status
      set_fact:
        tailscale_data: "{{ tailscale_status.stdout | from_json }}"
      when: tailscale_status.rc == 0
      
    - name: Check if tailscale is already connected
      set_fact:
        tailscale_connected: "{{ tailscale_data is defined and tailscale_data.BackendState == 'Running' }}"
      when: tailscale_status.rc == 0
      
    - name: Set tailscale as disconnected if status check failed
      set_fact:
        tailscale_connected: false
      when: tailscale_status.rc != 0
      
    # K8s ì„œë¹„ìŠ¤ ì„œë¸Œë„·ê³¼ íŒŒë“œ ì„œë¸Œë„·ì„ advertise
    - name: Connect to headscale server with K8s subnets
      command: >
        tailscale up 
        --login-server={{ headscale_server_url }} 
        --authkey={{ headscale_preauth_key }}
        --accept-routes
        --advertise-routes={{ k8s_pod_subnet }},{{ k8s_service_subnet }},{{ ansible_default_ipv4.network }}/{{ ansible_default_ipv4.netmask | ipaddr('prefix') }}
        --hostname={{ inventory_hostname }}-k8s-cp
      when: not tailscale_connected and headscale_preauth_key is defined
      register: tailscale_connect
      vars:
        k8s_pod_subnet: "10.244.0.0/16"
        k8s_service_subnet: "10.96.0.0/12"
        
    - name: Display connection instructions if no pre-auth key
      debug:
        msg: |
          ğŸ“‹ Tailscale ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
          
          ìˆ˜ë™ìœ¼ë¡œ ì—°ê²°í•˜ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:
          sudo tailscale up --login-server={{ headscale_server_url }} --accept-routes \
            --advertise-routes={{ k8s_pod_subnet }},{{ k8s_service_subnet }},{{ ansible_default_ipv4.network }}/{{ ansible_default_ipv4.netmask | ipaddr('prefix') }} \
            --hostname={{ inventory_hostname }}-k8s-cp
          
          ê·¸ ë‹¤ìŒ headscale ì„œë²„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë…¸ë“œì™€ ë¼ìš°íŠ¸ë¥¼ ìŠ¹ì¸í•˜ì„¸ìš”:
          headscale nodes list
          headscale routes list
          headscale routes enable -r <route-id>
      when: not tailscale_connected and headscale_preauth_key is not defined
      vars:
        k8s_pod_subnet: "10.244.0.0/16"
        k8s_service_subnet: "10.96.0.0/12"
        
    - name: Get tailscale status after connection
      command: tailscale status
      register: final_tailscale_status
      when: tailscale_connected or (tailscale_connect is defined and tailscale_connect.rc == 0)
      
    - name: Display tailscale network information
      debug:
        msg: |
          ğŸ”— K8s Control Plane Tailscale ì—°ê²° ì™„ë£Œ!
          
          {{ final_tailscale_status.stdout }}
          
          ë„¤íŠ¸ì›Œí¬ ì •ë³´:
          - í˜¸ìŠ¤íŠ¸ ì„œë¸Œë„·: {{ ansible_default_ipv4.network }}/{{ ansible_default_ipv4.netmask | ipaddr('prefix') }}
          - K8s Pod ì„œë¸Œë„·: {{ k8s_pod_subnet }}
          - K8s Service ì„œë¸Œë„·: {{ k8s_service_subnet }}
          - Headscale ì„œë²„: {{ headscale_server_url }}
      when: final_tailscale_status is defined
      vars:
        k8s_pod_subnet: "10.244.0.0/16"
        k8s_service_subnet: "10.96.0.0/12"
        
    # K8s ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Tailscale IP ì‚¬ìš©)
    - name: Get Tailscale IP address
      shell: tailscale ip -4
      register: tailscale_ip
      when: tailscale_connected or (tailscale_connect is defined and tailscale_connect.rc == 0)
      
    - name: Create Kubernetes initialization script
      copy:
        content: |
          #!/bin/bash
          set -euo pipefail
          
          TAILSCALE_IP="{{ tailscale_ip.stdout | default('') }}"
          
          if [ -z "$TAILSCALE_IP" ]; then
              echo "ERROR: Tailscale IP not found. Make sure Tailscale is connected."
              exit 1
          fi
          
          echo "ğŸš€ Initializing Kubernetes with Tailscale IP: $TAILSCALE_IP"
          
          # kubeadm ì´ˆê¸°í™”
          kubeadm init \
              --apiserver-advertise-address="$TAILSCALE_IP" \
              --apiserver-cert-extra-sans="$TAILSCALE_IP" \
              --pod-network-cidr=10.244.0.0/16 \
              --service-cidr=10.96.0.0/12 \
              --cri-socket=unix:///var/run/crio/crio.sock \
              --control-plane-endpoint="$TAILSCALE_IP:6443"
          
          # kubeconfig ì„¤ì •
          mkdir -p /root/.kube
          cp -i /etc/kubernetes/admin.conf /root/.kube/config
          chown root:root /root/.kube/config
          
          mkdir -p /home/ubuntu/.kube
          cp -i /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
          chown ubuntu:ubuntu /home/ubuntu/.kube/config
          
          # Flannel CNI ì„¤ì¹˜
          kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
          
          echo "âœ… Kubernetes Control Plane initialized successfully!"
          echo "ğŸ“‹ Join command for worker nodes:"
          kubeadm token create --print-join-command
          
          echo ""
          echo "ğŸ”— Kubernetes API ServerëŠ” Tailscale ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤:"
          echo "   kubectl cluster-info"
        dest: /opt/init-k8s-tailscale.sh
        mode: '0755'
        owner: root
        group: root
      when: tailscale_ip is defined and tailscale_ip.stdout != ""
      
    - name: Create Kubernetes cluster access helper script
      copy:
        content: |
          #!/usr/bin/env bash
          # Kubernetes í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ ë„êµ¬
          
          set -euo pipefail
          
          TAILSCALE_IP="{{ tailscale_ip.stdout | default('') }}"
          KUBECONFIG_LOCAL="/tmp/k8s-{{ inventory_hostname }}-config"
          
          case "${1:-help}" in
            "init")
              echo "ğŸš€ Kubernetes í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™” ì¤‘..."
              /opt/init-k8s-tailscale.sh
              ;;
            "status")
              echo "ğŸ“Š í´ëŸ¬ìŠ¤í„° ìƒíƒœ:"
              kubectl cluster-info
              echo ""
              kubectl get nodes -o wide
              ;;
            "join-cmd")
              echo "ğŸ“‹ Worker ë…¸ë“œ ì¡°ì¸ ëª…ë ¹ì–´:"
              kubeadm token create --print-join-command
              ;;
            "export-config")
              if [ -f /etc/kubernetes/admin.conf ]; then
                  echo "ğŸ“¤ Kubeconfig ë‚´ë³´ë‚´ëŠ” ì¤‘..."
                  sed "s/https:\/\/.*:6443/https:\/\/$TAILSCALE_IP:6443/g" /etc/kubernetes/admin.conf > "$KUBECONFIG_LOCAL"
                  echo "âœ… Kubeconfig ì €ì¥ë¨: $KUBECONFIG_LOCAL"
                  echo ""
                  echo "ë¡œì»¬ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´:"
                  echo "  export KUBECONFIG=$KUBECONFIG_LOCAL"
                  echo "  kubectl get nodes"
              else
                  echo "âŒ Kubernetesê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                  exit 1
              fi
              ;;
            "tailscale-info")
              echo "ğŸ”— Tailscale ë„¤íŠ¸ì›Œí¬ ì •ë³´:"
              echo "  Tailscale IP: $TAILSCALE_IP"
              echo "  API Server: https://$TAILSCALE_IP:6443"
              echo ""
              tailscale status
              ;;
            "help"|*)
              echo "Kubernetes Tailscale í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ ë„êµ¬"
              echo ""
              echo "ì‚¬ìš©ë²•: $0 <command>"
              echo ""
              echo "Commands:"
              echo "  init           - Kubernetes í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”"
              echo "  status         - í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸"
              echo "  join-cmd       - Worker ë…¸ë“œ ì¡°ì¸ ëª…ë ¹ì–´ ìƒì„±"
              echo "  export-config  - ì™¸ë¶€ ì ‘ê·¼ìš© kubeconfig ìƒì„±"
              echo "  tailscale-info - Tailscale ë„¤íŠ¸ì›Œí¬ ì •ë³´"
              echo "  help           - ë„ì›€ë§ í‘œì‹œ"
              ;;
          esac
        dest: /usr/local/bin/k8s-tailscale
        mode: '0755'
        owner: root
        group: root
      when: tailscale_ip is defined and tailscale_ip.stdout != ""
      
    - name: Create Tailscale-aware monitoring script for K8s
      copy:
        content: |
          #!/usr/bin/env bash
          # K8s + Tailscale ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸
          
          LOG_FILE="/var/log/k8s-tailscale-monitor.log"
          
          log_message() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
          }
          
          check_tailscale() {
              if tailscale status --json | jq -e '.BackendState == "Running"' > /dev/null 2>&1; then
                  return 0
              else
                  return 1
              fi
          }
          
          check_k8s_apiserver() {
              if kubectl cluster-info > /dev/null 2>&1; then
                  return 0
              else
                  return 1
              fi
          }
          
          check_k8s_nodes() {
              local ready_nodes
              ready_nodes=$(kubectl get nodes --no-headers 2>/dev/null | grep -c "Ready" || echo "0")
              if [ "$ready_nodes" -gt 0 ]; then
                  return 0
              else
                  return 1
              fi
          }
          
          # Tailscale ì—°ê²° í™•ì¸
          if ! check_tailscale; then
              log_message "WARNING: Tailscale is not running"
              systemctl restart tailscaled
              sleep 10
          fi
          
          # K8s API ì„œë²„ í™•ì¸
          if ! check_k8s_apiserver; then
              log_message "WARNING: Kubernetes API server is not accessible"
          fi
          
          # K8s ë…¸ë“œ ìƒíƒœ í™•ì¸
          if ! check_k8s_nodes; then
              log_message "WARNING: No Kubernetes nodes are ready"
          fi
          
          # ì„±ê³µì ì¸ ì²´í¬
          if check_tailscale && check_k8s_apiserver && check_k8s_nodes; then
              log_message "INFO: All systems operational"
          fi
        dest: /usr/local/bin/k8s-tailscale-monitor
        mode: '0755'
        owner: root
        group: root
        
    - name: Create systemd service for K8s + Tailscale monitoring
      copy:
        content: |
          [Unit]
          Description=Monitor K8s and Tailscale Connection
          After=tailscaled.service kubelet.service
          
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/k8s-tailscale-monitor
          User=root
        dest: /etc/systemd/system/k8s-tailscale-monitor.service
        
    - name: Create systemd timer for K8s + Tailscale monitoring
      copy:
        content: |
          [Unit]
          Description=Run K8s Tailscale Monitor every 5 minutes
          Requires=k8s-tailscale-monitor.service
          
          [Timer]
          OnCalendar=*:0/5
          Persistent=true
          
          [Install]
          WantedBy=timers.target
        dest: /etc/systemd/system/k8s-tailscale-monitor.timer
        
    - name: Enable and start K8s Tailscale monitoring timer
      systemd:
        daemon_reload: yes
        name: k8s-tailscale-monitor.timer
        enabled: yes
        state: started
        
    - name: Display final instructions
      debug:
        msg: |
          âœ… K8s Control Plane + Tailscale ì„¤ì • ì™„ë£Œ!
          
          ë‹¤ìŒ ë‹¨ê³„:
          1. Headscale ì„œë²„ì—ì„œ ë¼ìš°íŠ¸ ìŠ¹ì¸:
             headscale routes list
             headscale routes enable -r <route-id>
          
          2. Kubernetes í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”:
             sudo k8s-tailscale init
          
          3. ì™¸ë¶€ì—ì„œ í´ëŸ¬ìŠ¤í„° ì ‘ê·¼:
             sudo k8s-tailscale export-config
          
          4. ëª¨ë‹ˆí„°ë§:
             sudo k8s-tailscale status
             tail -f /var/log/k8s-tailscale-monitor.log