---
# DucksNest Homelab - ë©”ì¸ í”Œë ˆì´ë¶
# ì „ì²´ ì¸í”„ë¼ë¥¼ ì„¤ì •í•˜ê³  ê´€ë¦¬í•˜ëŠ” í”Œë ˆì´ë¶

- name: DucksNest Homelab Infrastructure Setup
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display deployment start message
      debug:
        msg: "ğŸ¦† DucksNest Homelab ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

# 1. ê³µí†µ ì‹œìŠ¤í…œ ì„¤ì •
- import_playbook: playbooks/common.yml

# 2. Tailscale í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ (ëª¨ë“  ë…¸ë“œ)
- import_playbook: playbooks/tailscale.yml

# 3. Jenkins & Headscale ì„œë²„ ì„¤ì •
- import_playbook: playbooks/jenkins-headscale.yml

# 4. Kubernetes Control Plane ì„¤ì •
- import_playbook: playbooks/k8s-control-plane.yml

# 5. ìµœì¢… ê²€ì¦
- name: Final Verification
  hosts: all
  gather_facts: true
  tasks:
    - name: Display system status
      debug:
        msg: |
          Host: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Uptime: {{ ansible_uptime_seconds | default(0) | int | human_readable }}
          Memory: {{ ansible_memory_mb.real.used }}MB / {{ ansible_memory_mb.real.total }}MB
          
    - name: Check service status
      systemd:
        name: "{{ item }}"
        state: started
      loop:
        - ssh
        - ufw
      ignore_errors: true
      
- name: Deployment Complete
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      debug:
        msg: |
          ğŸ‰ DucksNest Homelab ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
          
          ğŸ“Š Jenkins: http://{{ hostvars[groups['jenkins_headscale'][0]]['ansible_host'] }}:8080
          ğŸ”— Headscale: https://{{ hostvars[groups['jenkins_headscale'][0]]['ansible_host'] }}
          â˜¸ï¸  Kubernetes API: https://{{ hostvars[groups['k8s_control_plane'][0]]['tailscale_ip'] | default('TAILSCALE_IP') }}:6443
          
          ë‹¤ìŒ ë‹¨ê³„:
          1. Tailscale í´ë¼ì´ì–¸íŠ¸ë“¤ì„ Headscaleì— ë“±ë¡
          2. Jenkins ì´ˆê¸° ì„¤ì • ì™„ë£Œ
          3. ì˜¨í”„ë ˆë¯¸ìŠ¤ ì›Œì»¤ ë…¸ë“œë“¤ì„ í´ëŸ¬ìŠ¤í„°ì— ì¡°ì¸