name: Terraform version and provider checker

on:
  pull_request:
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  push:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options: [plan, apply, destroy]

env:
  TF_VERSION: '1.13.1'
  AWS_REGION: ${{ vars.AWS_REGION }}
  TERRAFORM_DIR: 'infra/terraform'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform-validate-and-plan:
    name: Terraform Validation & Plan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TERRAFORM_DIR }}

    steps:  # â† defaultsì™€ ê°™ì€ ê¹Šì´ì—¬ì•¼ í•©ë‹ˆë‹¤
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # (ì„ íƒ) í”ŒëŸ¬ê·¸ì¸/ëª¨ë“ˆ ìºì‹œ
      - name: âš¡ Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            ${{ env.TERRAFORM_DIR }}/.terraform
          key: ${{ runner.os }}-tf-${{ env.TF_VERSION }}-${{ hashFiles('**/.terraform.lock.hcl') }}

      - name: ğŸ”§ Set plugin cache dir
        run: echo "TF_PLUGIN_CACHE_DIR=$HOME/.terraform.d/plugin-cache" >> $GITHUB_ENV

      - name: ğŸ” Terraform Version
        run: terraform version

      - name: ğŸ” Required Providers (from config)
        run: terraform providers

      # ë½íŒŒì¼ ì—†ìœ¼ë©´ ì‹¤íŒ¨, ë°±ì—”ë“œ ë¹„í™œì„±í™”(initë§Œ í™•ì¸)
      - name: ğŸ§± Init (no backend, lockfile enforced)
        run: |
          if [ ! -f ".terraform.lock.hcl" ]; then
            echo "::error::.terraform.lock.hcl is missing. Run 'terraform init' locally and commit the lockfile."
            exit 1
          fi
          terraform init -backend=false -input=false -lockfile=readonly

      - name: ğŸ” Print locked provider versions
        run: |
          echo "--------- .terraform.lock.hcl (providers) ----------"
          awk '/^provider /,/^}/' .terraform.lock.hcl || true
          echo "----------------------------------------------------"

      - name: âœ… Terraform Validate
        run: terraform validate
