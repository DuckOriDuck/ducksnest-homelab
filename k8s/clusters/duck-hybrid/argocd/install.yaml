---
# Argo CD installation manifest
# This file should be applied manually once to bootstrap Argo CD
#
# Installation:
#   kubectl create namespace argocd
#   kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
#   kubectl apply -f k8s/clusters/duck-hybrid/argocd/install.yaml
#
# Then apply the root application:
#   kubectl apply -f k8s/clusters/duck-hybrid/argocd/root-application.yaml
#
# Access Argo CD UI:
#   kubectl port-forward svc/argocd-server -n argocd 8080:443
#   # Get initial admin password:
#   kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

---
# ConfigMap for Argo CD customization
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # Enable auto-sync by default
  application.instanceLabelKey: argocd.argoproj.io/instance

  # Timeout settings
  timeout.reconciliation: 180s

  # Git repository credentials (if using private repo)
  # repositories: |
  #   - url: https://github.com/<GITHUB_USER>/ducksnest-homelab.git
  #     passwordSecret:
  #       name: github-secret
  #       key: password
  #     usernameSecret:
  #       name: github-secret
  #       key: username

---
# RBAC ConfigMap for Argo CD
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  # Default policy is role:readonly
  policy.default: role:readonly

  # Admin users (customize as needed)
  policy.csv: |
    p, role:admin, applications, *, */*, allow
    p, role:admin, clusters, get, *, allow
    p, role:admin, repositories, *, *, allow
    p, role:admin, logs, get, *, allow
    p, role:admin, exec, create, */*, allow

    g, admin, role:admin

---
# Argo CD Server service - expose via NodePort for Tailscale access
apiVersion: v1
kind: Service
metadata:
  name: argocd-server-nodeport
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: argocd-server
  ports:
    - name: http
      port: 80
      targetPort: 8080
      nodePort: 30080
    - name: https
      port: 443
      targetPort: 8080
      nodePort: 30443
