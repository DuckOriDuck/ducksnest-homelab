# K8Nix

Collection of useful tools for Kubernetes on Nix by Lux

# This Code Originated from
https://gitlab.com/luxzeitlos/k8nix

## certToolkit

Allows you to define certs in nix modules, generate them with a nix app in your repo, and deploy them with agenix

Define your CAs in a dedicated module:
```nix
{ lib, config, ... }:
{
  certToolkit.dir = "./secrets/certs";
  certToolkit.userAgeIdentity = "$HOME/.ssh/id_rsa";
  certToolkit.userAgeKeys = ["..."]
  certToolkit.owningHostKey = "./ssh-host-keys/${config.networking.hostName}/ssh_host_ed25519_key.pub";

  certToolkit.defaults = {
    key = {
      algo = "rsa";
      size = 2048;
    };
  };

  certToolkit.cas.etcd.ca = {
    usages = [ "signing" ];
    expiry = "876000h";
    commonName = "Autogenerated CA for etcd";
  };
}
```

Add the module to your nixosSystem and define your app in your flake:
```nix
{
  inputs.nixpkgs.url = "nixpkgs/nixos-25.05";
  inputs.k8nix.url = "path:/home/lux/git/contrib/K8Nix";
  inputs.agenix.url = "github:ryantm/agenix";
  inputs.flake-utils.url = "github:numtide/flake-utils";

  outputs = { self, nixpkgs, flake-utils, agenix, k8nix }@inputs: {
    nixosConfigurations.myHost = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      specialArgs = inputs;
      modules = [
        agenix.nixosModules.default
        k8nix.nixosModules.certToolkit
        ./my-host.nix
      ];
    };
  } // flake-utils.lib.eachDefaultSystem (system: {
    apps = {
      certs.recreate = k8nix.mkRecreateCertsApp {
        inherit system;
        nixosConfigurations = self.nixosConfigurations;
        caModules = [./modules/certs/cas.nix];
      };
    };
  });
}
```

Define your certs:
```nix
certToolkit.cas.etcd.certs.service = {
  commonName = "etcd";
  hosts = [ config.networking.hostName ];
  owner = "etcd";
  usages = [ "signing" ];
  expiry = "876000h";
};
```

Create them with `nix run .#certs.recreate`, `git add`them, and use them like this:
```nix
trustedCaFile = "${config.certToolkit.cas.etcd.ca.path}";
certFile = "${config.certToolkit.cas.etcd.certs.service.path}";
keyFile = "${config.certToolkit.cas.etcd.certs.service.keyPath}";
```

# Kubernetes multi-yaml Addons

Utilize `services.kubernetes.addonManager` to deploy multi document YAML files (like the ones provided by `cert-manager`) to your cluster!

Just add `k8nix.nixosModules.kubernetesMultiYamlAddons` to your modules, and use it:

```nix
services.kubernetes.addonManager.multiYamlAddons.certManager = rec {
  name = "cert-manager";
  version = "1.18.2";
  src = builtins.fetchurl {
    url = "https://github.com/cert-manager/cert-manager/releases/download/v${version}/cert-manager.yaml";
    sha256 = "sha256:0vx1nfyhl0rzb6psfxplq8pfp18mrrdk83n8rj2ph8q6r15vcih5";
  };
};
```